<!DOCTYPE html>

{% extends 'core/base_authenticated.html' %}
{% load static %}
{% block content %}



<div class="container">
    <div class="row">
        <div class="col">
            <h1>Interview Calendar</h1>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <button type="button" class="btn btn-primary" id="addInterviewButton" data-bs-toggle="modal" data-bs-target="#addInterview">
                Add Job
            </button>
        </div>
    </div>
    <div id="calendar"></div>
</div>


<div class="modal fade" id="addInterview" tabindex="-1" aria-labelledby="addInterviewLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <p class="modal-title" id="addInterviewLabel">Add Interview</p>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% load crispy_forms_tags %}
                <form method="POST" id="addInterviewForm">
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="add">
                    {{ add_form|crispy }}

                    <h5>Alerts</h5>
                    <ul class="list-group" id="alertList">
                        <!-- Alerts will be dynamically populated here -->
                        <li class="list-group-item text-center" id="addAlertAction">
                            <button type="button" class="btn btn-link" data-bs-toggle="modal" data-bs-target="#addAlertModal">
                                + Add Alert
                            </button>
                        </li>
                    </ul>

                    <button type="submit" class="btn btn-primary mt-3">Submit</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addAlertModal" tabindex="-1" aria-labelledby="addAlertModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <p class="modal-title" id="addAlertModalLabel">Add Alert</p>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addAlertForm">
                    {{ add_alert_form|crispy }}
                    <button type="button" class="btn btn-primary" id="saveAlert">Save Alert</button>
                </form>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="viewInterview" tabindex="-1" aria-labelledby="viewInterviewLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <p class="modal-title" id="viewInterviewLabel">Add Interview</p>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="modal-body-content">

                </div>
                <div class="row">
                    <div class="col">
                        <h5>Tasks</h5>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="list-group">

                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
</div>


<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<!-- <script src="{% static 'interview/scripts/calendar.js' %}" defer></script> -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var events = JSON.parse('{{ interviews|escapejs }}');
    function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    };
    var calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      events: events,
      selectable: true,
      eventClick: function(info) {
                var event = info.event;
                var eventId = event.id;
                console.log("Event ID:", eventId);

                // Make an AJAX request to fetch interview details
                fetch(`/interview/event-detail/${eventId}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert('Error: ' + data.error);
                        } else {
                            // Populate the modal with interview data
                            document.getElementById('viewInterviewLabel').textContent = `Interview Details for ${data.title}`;
                            var modalBodyContent = document.querySelector('#viewInterview .modal-body-content');
                            var taskList = document.querySelector('#viewInterview .list-group');

                            
                            // Clear previous content (if any)
                            modalBodyContent.innerHTML = '';

                            // Fill modal with interview data
                            modalBodyContent.innerHTML += `<div class="row"><div class="col"><p><strong>Job Title:</strong> ${data.title}</p></div><div class="col"><p><strong>Company:</strong> ${data.company}</p></div></div>`;
                            modalBodyContent.innerHTML += `<div class="row"><div class="col"><p><strong>Date:</strong> ${data.date}</p></div></div>`;
                            modalBodyContent.innerHTML += `<div class="row"><div class="col"><p><strong>Start Time:</strong> ${data.start_time}</p></div><div class="col"><p><strong>End Time:</strong> ${data.end_time}</p></div></div>`;
                            modalBodyContent.innerHTML += `<div class="row"><div class="col"><p><strong>Notes:</strong> ${data.notes}</p></div></div>`;
                            
                            // Show the modal
                            
                            taskList.innerHTML = '';
                            // Fetch tasks and populate the task list
                            data.tasks.forEach(task => {

                                const taskItem = document.createElement('li');
                                taskItem.classList.add('list-group-item');

                                const taskForm = document.createElement('form');
                                taskForm.method = 'POST';
                                taskForm.action = '';
                                taskForm.form

                                const formType = document.createElement('input');
                                formType.type = 'hidden';
                                formType.name = 'form_type';
                                formType.value = 'update_task';

                                const checkBox = document.createElement('input')
                                checkBox.type = 'checkbox';
                                checkBox.checked = task.completed;

                                const row = document.createElement('div');
                                row.classList.add('row');

                                const col1 = document.createElement('div');
                                const col2 = document.createElement('div');

                                const name = document.createElement('span');
                                name.textContent = task.name;
                                col1.classList.add('col');
                                col2.classList.add('col');
                                col1.appendChild(name);
                                col2.appendChild(checkBox);
                                row.appendChild(col1);
                                row.appendChild(col2);
                                taskItem.appendChild(row);
                                taskList.appendChild(taskItem);

                                checkBox.addEventListener('change', function() {
                                    const isCompleted = this.checked;
                                    const taskId = task.id;

                                    fetch(`/interview/calendar/`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'X-CSRFToken': getCSRFToken(),
                                        },
                                        body: JSON.stringify({
                                            form_type: 'update_task',
                                            task_id: taskId,
                                            completed: isCompleted
                                        })
                                                              
                                
                                }); 
                            });
                        });

                            const taskItem = document.createElement('a');
                            const row = document.createElement('div');
                            const col = document.createElement('div');
                            const txt = document.createElement('span');
                            
                            row.classList.add('row');
                            row.classList.add('text-center');
                            col.classList.add('col');
                            txt.innerHTML = `<p class="display-5"><strong>+</strong></p>`;
                            
                            taskItem.classList.add('list-group-item');
                            taskItem.classList.add('list-group-item-action');
                            taskItem.href = `#`;
                            col.appendChild(txt);
                            row.appendChild(col);
                            taskItem.appendChild(row);
                            taskList.appendChild(taskItem);

                            var viewInterviewModal = new bootstrap.Modal(document.getElementById('viewInterview'));
                            viewInterviewModal.show();
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching interview details:', error);
                        alert('An error occurred while fetching the interview details.');
                    });
            }
    });
    
    calendar.render();
  });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
    const addInterviewModal = document.getElementById('addInterview');
    const addInterviewForm = document.getElementById('addInterviewForm');

    // Object to store form data
    const formData = {};

    // Save form data when the modal is hidden
    addInterviewModal.addEventListener('hide.bs.modal', function () {
        const formElements = addInterviewForm.elements;
        for (const element of formElements) {
            if (element.name) {
                formData[element.name] = element.value;
            }
        }
    });

    // Restore form data when the modal is shown
    addInterviewModal.addEventListener('show.bs.modal', function () {
        const formElements = addInterviewForm.elements;
        for (const element of formElements) {
            if (element.name && formData[element.name] !== undefined) {
                element.value = formData[element.name];
            }
        }
    });
});
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
    const alertList = document.getElementById('alertList');
    const addAlertForm = document.getElementById('addAlertForm');
    const saveAlertButton = document.getElementById('saveAlert');
    const addAlertAction = document.getElementById('addAlertAction');

    const alerts = [];

    saveAlertButton.addEventListener('click', function () {
        const formData = new FormData(addAlertForm);
        const alertData = {};

        // Extract form data
        formData.forEach((value, key) => {
            alertData[key] = value;
        });

        // Push alert data to the list
        alerts.push(alertData);

        // Update the alert list
        const listItem = document.createElement('li');
        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
        listItem.textContent = alertData.message; // Assuming "message" is a field in alert_form
        listItem.innerHTML += `
            <button type="button" class="btn btn-danger btn-sm" onclick="removeAlert(${alerts.length - 1})">
                Remove
            </button>
        `;
        alertList.insertBefore(listItem, addAlertAction);

        // Close the modal
        const addAlertModal = bootstrap.Modal.getInstance(document.getElementById('addAlertModal'));
        const addInterviewModel = bootstrap.Modal.getInstance(document.getElementById('addInterview'));
        addAlertModal.hide();
        
        addInterviewModel.show();
        // Reset the alert form
        addAlertForm.reset();
    });

    window.removeAlert = function (index) {
        alerts.splice(index, 1); // Remove from the array
        alertList.children[index].remove(); // Remove the corresponding list item
    };

    // On form submission, attach the alerts to the form as hidden inputs
    const addInterviewForm = document.getElementById('addInterviewForm');
    addInterviewForm.addEventListener('submit', function (e) {
        // Serialize alerts as a JSON string
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'alerts';
        hiddenInput.value = JSON.stringify(alerts); // Convert alerts array to JSON string
        addInterviewForm.appendChild(hiddenInput);
    });
});
</script>
{% endblock content %}